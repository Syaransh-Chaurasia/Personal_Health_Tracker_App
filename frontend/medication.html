<script>
    const token = localStorage.getItem('token');
    if (!token) window.location.href = 'index.html';

    const apiBase = 'https://personal-health-tracker-app-2.onrender.com';

    async function loadMedications() {
        const res = await fetch(`${apiBase}/medications`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) return alert('Failed to load medications');
        const meds = await res.json();
        const tbody = document.getElementById('medication-table');
        tbody.innerHTML = '';
        meds.forEach(m => {
            const takenLabel = m.taken ? '✅ Taken' : '❌ Not Taken';
            const actionText = m.taken ? 'Mark as Not Taken' : 'Mark as Taken';
            tbody.innerHTML += `
      <tr>
        <td>${m.name}</td>
        <td>${m.dosage}</td>
        <td>${m.frequency}</td>
        <td>${m.time_slots}</td>
        <td>${m.start_date}</td>
        <td>${m.end_date}</td>
        <td>${takenLabel}</td>
        <td>
          <button onclick="toggleTaken(${m.id})">${actionText}</button>
          <button onclick="deleteMedication(${m.id})" style="background-color:#dc3545;">Delete</button>
        </td>
      </tr>
    `;
        });
    }

    async function toggleTaken(id) {
        const res = await fetch(`${apiBase}/medications/${id}/toggle-taken`, {
            method: 'PATCH',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
        });
        if (res.ok) {
            alert('Status updated.');
            loadMedications();
        } else {
            alert('Failed to update.');
        }
    }

    async function deleteMedication(id) {
        const res = await fetch(`${apiBase}/medications/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) {
            alert('Deleted.');
            loadMedications();
        } else {
            alert('Error deleting.');
        }
    }

    document.getElementById('medication-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
            name: document.getElementById('name').value,
            dosage: document.getElementById('dosage').value,
            frequency: document.getElementById('frequency').value,
            time_slots: document.getElementById('time_slots').value,
            start_date: document.getElementById('start_date').value,
            end_date: document.getElementById('end_date').value
        };

        const res = await fetch(`${apiBase}/medications`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            alert('Medication added.');
            document.getElementById('medication-form').reset();
            loadMedications();
        } else {
            alert('Failed to add.');
        }
    });

    function logout() {
        localStorage.removeItem('token');
        window.location.href = 'index.html';
    }

    loadMedications();
</script>
