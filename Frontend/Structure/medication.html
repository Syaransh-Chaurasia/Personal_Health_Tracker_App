<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Medication Tracker</title>
    <link rel="stylesheet" href="static/index.css" />
</head>
<body>

<div class="sidebar">
    <h2>Navigation</h2>
    <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="medication.html">Medications</a></li>
        <li><a href="symptom.html">Symptoms</a></li>
        <li><a href="vitals.html">Vitals</a></li>
    </ul>
</div>

<main>
    <h1>Medication Tracker</h1>
    <form id="med-form">
        <div class="form-group"><label>Name: <input type="text" id="name" required></label></div>
        <div class="form-group"><label>Dosage: <input type="text" id="dosage" required></label></div>
        <div class="form-group"><label>Frequency: <input type="text" id="frequency" required></label></div>
        <div class="form-group"><label>Time Slots: <input type="text" id="time_slots" required></label></div>
        <div class="form-group"><label>Start Date: <input type="date" id="start_date" required></label></div>
        <div class="form-group"><label>End Date: <input type="date" id="end_date" required></label></div>
        <button class="btn" type="submit">Save Medication</button>
    </form>

    <ul id="med-list" style="text-align:left;"></ul>
</main>

<script>
    const API = "http://localhost:8000/medications";
    let editingId = null;

    document.getElementById("med-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = {
            name: name.value,
            dosage: dosage.value,
            frequency: frequency.value,
            time_slots: time_slots.value,
            start_date: start_date.value,
            end_date: end_date.value,
            taken: false
        };

        if (editingId) {
            await fetch(`${API}/${editingId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            editingId = null;
        } else {
            await fetch(API, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
        }

        loadMeds();
        e.target.reset();
    });

    async function loadMeds() {
        const res = await fetch(API);
        const meds = await res.json();
        const list = document.getElementById("med-list");
        list.innerHTML = "";
        meds.forEach(m => {
            const li = document.createElement("li");
            li.innerHTML = `
      <strong>${m.name}</strong> – ${m.dosage} – ${m.frequency}<br>
      ${m.start_date} to ${m.end_date} |
      <em>${m.taken ? "✅ Taken" : "❌ Not taken"}</em><br>
      <button onclick="editMed(${m.id}, '${m.name}', '${m.dosage}', '${m.frequency}', '${m.time_slots}', '${m.start_date}', '${m.end_date}')">Edit</button>
      <button onclick="toggle(${m.id})">Toggle</button>
      <button onclick="del(${m.id})">Delete</button>
    `;
            list.appendChild(li);
        });
    }

    function editMed(id, nameVal, dosageVal, freqVal, timeSlotsVal, startDateVal, endDateVal) {
        name.value = nameVal;
        dosage.value = dosageVal;
        frequency.value = freqVal;
        time_slots.value = timeSlotsVal;
        start_date.value = startDateVal;
        end_date.value = endDateVal;
        editingId = id;
    }

    async function toggle(id) {
        await fetch(`${API}/${id}/toggle-taken`, { method: "PATCH" });
        loadMeds();
    }

    async function del(id) {
        await fetch(`${API}/${id}`, { method: "DELETE" });
        loadMeds();
    }

    // Reminder every 20 minutes (1200000 ms)
    setInterval(() => {
        alert("💊 Reminder: It's time to check your medications!");
    }, 1200000);

    loadMeds();
</script>

</body>
</html>
